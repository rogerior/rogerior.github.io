<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rastreamento de Requisição</title>

  <!-- bpmn-js viewer -->
  <script src="https://unpkg.com/bpmn-js@11/dist/bpmn-viewer.development.js"></script>
  <!-- PapaParse para fazer o parse do CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    header { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    header div {
      display: flex;
      flex-direction: column;
      gap: .25rem;
      min-width: 220px;
    }
    input[type=text] {
      padding: .5rem .75rem; border: 1px solid #ccc; border-radius: .375rem;
      min-width: 220px;
    }
    header select {
      padding: .5rem .75rem;
      border: 1px solid #ccc;
      border-radius: .375rem;
      min-width: 220px;
      background-color: #fff;
    }
    button {
      padding: .5rem 1rem; background:#1976d2; color:#fff; border:none;
      border-radius:.375rem; cursor:pointer;
    }
    button:hover { background:#115293; }
    button:disabled {
      background: #ccc; cursor: not-allowed;
    }
    #status { padding:.5rem 0 0 .5rem; color:#d7191c; }
    #currentReq {
      margin-top: 1rem; color: #1976d2;
    }

    /* destaque da etapa atual */
    .djs-element.highlight > .djs-visual > :first-child {
      stroke: #00008b !important;
      stroke-width: 4 !important;
      fill: #add8e6 !important;
    }
    #canvas { width:100%; height:58vh; border:1px solid #eee; }
    @media(max-width:600px){ #canvas{height:95vh;} }

    /* Estilos para a seção de histórico */
    #historicoSection {
      display: none;
      margin-top: 1rem;
    }
    #historicoTable {
      width: 100%;
      border-collapse: collapse;
    }
    #historicoTable th, #historicoTable td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    #historicoTable th {
      background-color: #0072b9;
      color: #fff;
      text-align: left;
    }
    /* Linhas alternadas do histórico */
    #historicoTable tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    #historicoTable tbody tr:nth-child(even) {
      background-color: #e6f4fe;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <label for="reqInput">Número do DFD</label>
      <input id="reqInput" type="text" />
    </div>
    <div>
      <label for="classificacaoSelect">Classificação da contratação</label>
      <select id="classificacaoSelect">
        <option value="">Selecione a classificação</option>
        <option value="Material">Material</option>
        <option value="Serviço">Serviço</option>
      </select>
    </div>
    <div>
      <label for="itemInput">Nº do item no DFD</label>
      <input id="itemInput" type="text" />
    </div>
    <button id="buscarBtn">Buscar</button>
    <span id="status"></span>
  </header>

  <div id="canvas"></div>
  <div id="currentReq"></div>

  <!-- Seção de Histórico de movimentação -->
  <div id="historicoSection">
    <h2>Histórico de movimentação</h2>
    <table id="historicoTable" border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>Data/hora</th>
          <th>Nº DFD</th>
          <th>Etapa</th>
          <th>Responsável</th>
          <th>Duração na etapa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
  // ---------- CONFIGURE AQUI -------------------------------------------------
  // const SHEET_ID   = '1rNyN7sYhY9yxnk2QXKen6jnmr49d0WOv'; // planilha teste_rogerio
  // const SHEET_ID   = '1RuwHAtPGgFzhQS6yGv_heHLOIbakw0fQ'; // planilha oficial
  const SHEET_ID   = '1qzkVIkI1YoVkuhir18xxYmnVhEa0f3FD5rsaBamu-A4'; // planilha oficial
  const SHEET_NAME = 'Etapas';           // nome da aba publicada
  const CSV_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
  // Configuração da aba Histórico
  const HIST_SHEET_NAME = 'Histórico';
  const HIST_CSV_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(HIST_SHEET_NAME)}`;
  const BPMN_FILE  = 'processo.bpmn';    // diagrama exportado
  // --------------------------------------------------------------------------

  // Carrega diagrama BPMN
  const viewer = new BpmnJS({ container:'#canvas' });
  fetch(BPMN_FILE).then(r=>r.text()).then(xml=>viewer.importXML(xml));

  // Cache da planilha (evita vários downloads)
  let planilha = null;
  let historicoCache = null;
  async function carregarPlanilha() {
    // if (planilha) return planilha; // já carregada
    const csvText = await fetch(CSV_URL).then(r=>r.text());
    planilha = Papa.parse(csvText, { header:true }).data;
    /* Espera-se cabeçalho:
       Nº DFD, etapa
       REQ-2024-001, elaboracao_pca
    */
    return planilha;
  }
  // Função para carregar histórico (evita vários downloads)
  async function carregarHistorico() {
    // if (historicoCache) return historicoCache;
    const csvText = await fetch(HIST_CSV_URL).then(r=>r.text());
    historicoCache = Papa.parse(csvText, { header:true }).data;
    return historicoCache;
  }

  async function buscarEtapa(){
    const req = document.getElementById('reqInput').value.trim();
    const classificacao = document.getElementById('classificacaoSelect').value.trim();
    const item = document.getElementById('itemInput').value.trim();
    const status = document.getElementById('status');
    const buscarBtn = document.getElementById('buscarBtn');
    const currentReq = document.getElementById('currentReq');
    status.textContent = '';

    if (!req || !classificacao || !item){ 
      status.textContent = 'Preencha todos os campos da requisição.';
      buscarBtn.disabled = false;
      return;
    }

    buscarBtn.disabled = true;
    status.textContent = 'Buscando...';

    let dados;
    try { 
      dados = await carregarPlanilha(); 
    } catch (err) { 
      status.textContent = 'Falha ao carregar a planilha.';
      console.error(err);
      buscarBtn.disabled = false;
      return;
    }

    const registro = dados.find(l => l['Nº DFD'] === req && l['Classificação da contratação'] === classificacao && l['Nº do item no DFD'] === item);
    
    let etapaId;
    if (!registro) { 
      // Se a requisição não foi encontrada, direciona para a etapa padrão
      etapaId = 'Id_f08bb724-75f2-4079-8d3a-6cd3d522cfbd';
      status.textContent = 'Demanda não encontrada ou PCA não consolidado.';
    } else {
      etapaId = registro.etapa?.trim();
      status.textContent = '';
    }
    const canvas = viewer.get('canvas');
    const registry = viewer.get('elementRegistry');

    // Limpa marcações anteriores
    registry.forEach(el => canvas.removeMarker(el, 'highlight'));

    const el = registry.get(etapaId);
    if (!el) { 
      status.textContent = `Etapa “${etapaId}” não existe no diagrama.`;
      buscarBtn.disabled = false;
      return;
    }

    canvas.scrollToElement(el);
    canvas.addMarker(el, 'highlight');
    
    // Atualiza a exibição da requisição com informações adicionais
    if (!registro) {
      // Se não encontrou a requisição, exibe informações básicas
      currentReq.innerHTML = `<div style="color: black;">` +
                             `<p><h2>Demanda</h2></p>` +
                             `<p><strong>Nº DFD:</strong> ${req}</p>` +
                             `<p><strong>Classificação da contratação:</strong> ${classificacao}</p>` +
                             `<p><strong>Nº do item no DFD:</strong> ${item}</p>` +
                            //  `<p style="color: #d7191c;"><strong>Requisição não encontrada.</strong></p>` +
                             `</div>`;
    } else {
      // Se encontrou a requisição, exibe todas as informações
      currentReq.innerHTML = `<div style="color: black;">` +
                             `<p><h2>Demanda</h2></p>` +
                             `<p><strong>Nº DFD:</strong> ${req}</p>` +
                             `<p><strong>Classificação da contratação:</strong> ${classificacao}</p>` +
                             `<p><strong>Nº do item no DFD:</strong> ${item}</p>` +
                             `<p><strong>Nº do processo SEI:</strong> ${registro['Nº do processo SEI'] || ''}</p>` +
                             `<p><strong>Nº da compra:</strong> ${registro['Nº da compra'] || ''}</p>` +
                             `<p><strong>Nº da requisição do SIPAC:</strong> ${registro['Nº da requisição do SIPAC'] || ''}</p>` +
                             `</div>`;
    }
    // Carrega e exibe histórico de movimentação para esta requisição
    try {
      const todos = await carregarHistorico();
      let itens = todos.filter(l => l['Nº DFD'] === req);

      // Se a requisição não foi encontrada na planilha principal, 
      // não haverá histórico para exibir
      if (!registro) {
        document.getElementById('historicoSection').style.display = 'none';
      } else {
        // New simplified date parser for expected format dd/mm/yyyy [HH:MM[:SS]]
        function parseDate(dateStr) {
          if (!dateStr) return new Date(NaN);
          dateStr = dateStr.trim();
          if (dateStr.indexOf('/') > -1) {
            let parts = dateStr.split(' ');
            let dateParts = parts[0].split('/');
            if (dateParts.length !== 3) return new Date(NaN);
            let day = parseInt(dateParts[0], 10);
            let month = parseInt(dateParts[1], 10);
            let year = parseInt(dateParts[2], 10);
            let timeParts = parts[1] ? parts[1].split(':') : [];
            let hours = timeParts.length > 0 ? parseInt(timeParts[0], 10) : 0;
            let minutes = timeParts.length > 1 ? parseInt(timeParts[1], 10) : 0;
            let seconds = timeParts.length > 2 ? parseInt(timeParts[2], 10) : 0;
            return new Date(year, month - 1, day, hours, minutes, seconds);
          } else {
            return new Date(dateStr);
          }
        }

        // Sort items by Data/hora ascending
        itens.sort((a, b) => parseDate(a['Data/hora']) - parseDate(b['Data/hora']));

        const tbody = document.getElementById('historicoTable').querySelector('tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < itens.length; i++) {
          const item = itens[i];
          const tr = document.createElement('tr');
          ['Data/hora','Nº DFD','Etapa','Responsável'].forEach(col => {
            const td = document.createElement('td');
            td.textContent = item[col] || '';
            tr.appendChild(td);
          });
          let duration = '';
          if (i < itens.length - 1) {
            const currentTime = parseDate(item['Data/hora']);
            const nextTime = parseDate(itens[i + 1]['Data/hora']);
            const diffMs = nextTime - currentTime;
            if (!isNaN(diffMs) && diffMs >= 0) {
              const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
              duration = diffDays === 1 ? '1 dia' : (diffDays === 0 ? '0 dia' : diffDays + ' dias');
            }
          }
          const tdDuration = document.createElement('td');
          tdDuration.textContent = duration;
          tr.appendChild(tdDuration);
          tbody.appendChild(tr);
        }
        document.getElementById('historicoSection').style.display = itens.length ? 'block' : 'none';
      }
    } catch(err) {
      console.error('Erro ao carregar histórico:', err);
    }
    buscarBtn.disabled = false;
  }

  document.getElementById('buscarBtn').addEventListener('click',buscarEtapa);
  document.getElementById('reqInput').addEventListener('keyup',e=>{
    if(e.key==='Enter') buscarEtapa();
  });
  </script>
</body>
</html>
