<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rastreamento de Requisição</title>

  <!-- bpmn-js viewer -->
  <script src="https://unpkg.com/bpmn-js@11/dist/bpmn-viewer.development.js"></script>
  <!-- PapaParse para fazer o parse do CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    header { display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    input[type=text] {
      padding: .5rem .75rem; border: 1px solid #ccc; border-radius: .375rem;
      min-width: 220px;
    }
    button {
      padding: .5rem 1rem; background:#1976d2; color:#fff; border:none;
      border-radius:.375rem; cursor:pointer;
    }
    button:hover { background:#115293; }
    button:disabled {
      background: #ccc; cursor: not-allowed;
    }
    #status { padding:.5rem 0 0 .5rem; color:#d7191c; }
    #currentReq {
      margin-top: 1rem; font-weight: bold; color: #1976d2;
    }

    /* destaque da etapa atual */
    .djs-element.highlight > .djs-visual > :first-child {
      stroke: #00008b !important;
      stroke-width: 4 !important;
      fill: #add8e6 !important;
    }
    #canvas { width:100%; height:58vh; border:1px solid #eee; }
    @media(max-width:600px){ #canvas{height:95vh;} }

    /* Estilos para a seção de histórico */
    #historicoSection {
      display: none;
      margin-top: 1rem;
    }
    #historicoTable {
      width: 100%;
      border-collapse: collapse;
    }
    #historicoTable th, #historicoTable td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    #historicoTable th {
      background-color: #0072b9;
      color: #fff;
      text-align: left;
    }
    /* Linhas alternadas do histórico */
    #historicoTable tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    #historicoTable tbody tr:nth-child(even) {
      background-color: #e6f4fe;
    }
  </style>
</head>
<body>
  <header>
    <input id="reqInput" placeholder="Número do DFD" />
    <select id="classificacaoSelect">
      <option value="">Selecione a classificação</option>
      <option value="Material">Material</option>
      <option value="Serviço">Serviço</option>
    </select>
    <input id="itemInput" placeholder="Nº do item no DFD" type="text" />
    <button id="buscarBtn">Buscar</button>
    <span id="status"></span>
  </header>

  <div id="canvas"></div>
  <div id="currentReq"></div>
  <!-- Seção de Histórico de movimentação -->
  <div id="historicoSection">
    <h2>Histórico de movimentação</h2>
    <table id="historicoTable" border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>Data/hora</th>
          <th>Nº DFD</th>
          <th>Status</th>
          <th>Responsável</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
  // ---------- CONFIGURE AQUI -------------------------------------------------
  // const SHEET_ID   = '1rNyN7sYhY9yxnk2QXKen6jnmr49d0WOv'; // planilha teste_rogerio
  // const SHEET_ID   = '1RuwHAtPGgFzhQS6yGv_heHLOIbakw0fQ'; // planilha oficial
  const SHEET_ID   = '1qzkVIkI1YoVkuhir18xxYmnVhEa0f3FD5rsaBamu-A4'; // planilha oficial
  const SHEET_NAME = 'Etapas';           // nome da aba publicada
  const CSV_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
  // Configuração da aba Histórico
  const HIST_SHEET_NAME = 'Histórico';
  const HIST_CSV_URL    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(HIST_SHEET_NAME)}`;
  const BPMN_FILE  = 'processo.bpmn';    // diagrama exportado
  // --------------------------------------------------------------------------

  // Carrega diagrama BPMN
  const viewer = new BpmnJS({ container:'#canvas' });
  fetch(BPMN_FILE).then(r=>r.text()).then(xml=>viewer.importXML(xml));

  // Cache da planilha (evita vários downloads)
  let planilha = null;
  let historicoCache = null;
  async function carregarPlanilha() {
    // if (planilha) return planilha; // já carregada
    const csvText = await fetch(CSV_URL).then(r=>r.text());
    planilha = Papa.parse(csvText, { header:true }).data;
    /* Espera-se cabeçalho:
       Nº DFD, etapa
       REQ-2024-001, elaboracao_pca
    */
    return planilha;
  }
  // Função para carregar histórico (evita vários downloads)
  async function carregarHistorico() {
    // if (historicoCache) return historicoCache;
    const csvText = await fetch(HIST_CSV_URL).then(r=>r.text());
    historicoCache = Papa.parse(csvText, { header:true }).data;
    return historicoCache;
  }

  async function buscarEtapa(){
    const req = document.getElementById('reqInput').value.trim();
    const classificacao = document.getElementById('classificacaoSelect').value.trim();
    const item = document.getElementById('itemInput').value.trim();
    const status = document.getElementById('status');
    const buscarBtn = document.getElementById('buscarBtn');
    const currentReq = document.getElementById('currentReq');
    status.textContent = '';

    if (!req || !classificacao || !item){ 
      status.textContent = 'Preencha todos os campos da requisição.';
      buscarBtn.disabled = false;
      return;
    }

    buscarBtn.disabled = true;
    status.textContent = 'Buscando...';

    let dados;
    try { 
      dados = await carregarPlanilha(); 
    } catch (err) { 
      status.textContent = 'Falha ao carregar a planilha.';
      console.error(err);
      buscarBtn.disabled = false;
      return;
    }

    const registro = dados.find(l => l['Nº DFD'] === req && l['Classificação da contratação'] === classificacao && l['Nº do item no DFD'] === item);
    if (!registro) { 
      status.textContent = 'Requisição não encontrada.';
      buscarBtn.disabled = false;
      return;
    }

    const etapaId = registro.etapa?.trim();
    const canvas = viewer.get('canvas');
    const registry = viewer.get('elementRegistry');

    // Limpa marcações anteriores
    registry.forEach(el => canvas.removeMarker(el, 'highlight'));

    const el = registry.get(etapaId);
    if (!el) { 
      status.textContent = `Etapa “${etapaId}” não existe no diagrama.`;
      buscarBtn.disabled = false;
      return;
    }

    canvas.scrollToElement(el);
    canvas.addMarker(el, 'highlight');
    status.textContent = '';
    // Atualiza a exibição da requisição com informações adicionais
    currentReq.innerHTML = `<div style="color: black;">` +
                           `<p><h2>Requisição</h2></p>` +
                           `<p>Nº DFD: ${req}</p>` +
                           `<p>Classificação da contratação: ${classificacao}</p>` +
                           `<p>Nº do item no DFD: ${item}</p>` +
                           `<p>Nº do processo SEI: ${registro['Nº do processo SEI'] || ''}</p>` +
                           `<p>Nº da compra: ${registro['Nº da compra'] || ''}</p>` +
                           `<p>Nº da requisição do SIPAC: ${registro['Nº da requisição do SIPAC'] || ''}</p>` +
                           `</div>`;
    // Carrega e exibe histórico de movimentação para esta requisição
    try {
      const todos = await carregarHistorico();
      const itens = todos.filter(l => l['Nº DFD'] === req);
      const tbody = document.getElementById('historicoTable').querySelector('tbody');
      tbody.innerHTML = '';
      itens.forEach(item => {
        const tr = document.createElement('tr');
        ['Data/hora','Nº DFD','Status','Responsável'].forEach(col => {
          const td = document.createElement('td');
          td.textContent = item[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      document.getElementById('historicoSection').style.display = itens.length ? 'block' : 'none';
    } catch(err) {
      console.error('Erro ao carregar histórico:', err);
    }
    buscarBtn.disabled = false;
  }

  document.getElementById('buscarBtn').addEventListener('click',buscarEtapa);
  document.getElementById('reqInput').addEventListener('keyup',e=>{
    if(e.key==='Enter') buscarEtapa();
  });
  </script>
</body>
</html>
